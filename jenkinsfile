pipeline{
    agent{
        docker { 
            image 'my-light-dev-tools-all' 
            args '--privileged --user 0'
        }
        
    }

    environment{
        appsurl = "github.com/edwinmalihu/customer-service-fly.git"
        appname = "customer-service-fly"
        urlregistry = "https://registry-1.docker.io"
        myrepo = "edwinmalihu"

    }

    stages{
        stage("Clone Source"){
            steps{
                script{
                    cleanWs()
                    withCredentials([string(credentialsId: 'token-github', variable: 'GITHUB_TOKEN')]) {
                        sh """
                            git clone --branch main https://oauth2:${GITHUB_TOKEN}@$appsurl $appname
                        """
                    }  
                }
            }
        }

        stage("Build & Push Image"){
            steps{
                script{
                    withCredentials([usernamePassword(credentialsId: 'docker-hub-cred', passwordVariable: 'password', usernameVariable: 'username')]) {
                        sh """
                            cd $appname
                            ls
                            podman login -u ${username} -p ${password} $urlregistry
                            podman build -t $appname -f dockerfile .
                            podman tag $appname docker.io/$myrepo/$appname-test:0.0.1
                            podman push docker.io/$myrepo/$appname-test:0.0.1
                        """
                    }
                }
            }
        }

        stage("Deploy To Fly.io"){
            steps{
                script{
                    sh "fly version"
                    echo "Deploy Service"
                }
            }
        }
    }
}